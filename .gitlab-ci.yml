
image : docker:latest

services :
  - docker:dind
  
variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  IMAGE_NAME: tetrisant:${CI_COMMIT_REF_NAME}
stages:
  - build
  - publishmanual

build_job:
  stage: build
  script:
    - echo "Image Name:${IMAGE_NAME}"
    - docker build -t tetrisant .
    - docker images
	- docker run --name tetriscontainer tetrisant
	- docker cp tetriscontainer:app/Tetris.jar Tetris.jar
	- docker cp tetriscontainer:app/test-reports test-reports
	- docker stop tetriscontainer
	- docker rm tetriscontainer
  artifacts:
    paths:
      - Tetris.jar
      - test-reports	
      
publish_manual_job:
  stage: publishmanual
  script:
    - echo "Publishing application"
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - docker push ${IMAGE_NAME}
  when: manual
  only:
    - tags
    - master
  dependencies:
      - "build_job"